{% extends 'base.html.twig' %}

{% block body %}
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .card-deidad { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #eee; }
        tr.fila-usuario:hover { background-color: #f8f9fa; cursor: pointer; transition: 0.2s; }
        .btn-pag { padding: 8px 14px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-weight: bold; background: white; transition: 0.2s; }
        .btn-pag:hover:not(:disabled) { background: #f0f0f0; }
        .btn-pag:disabled { cursor: not-allowed; opacity: 0.5; }
        .active { background: #007bff !important; color: white !important; border-color: #007bff !important; }
        .input-busqueda:focus { border-color: #007bff !important; box-shadow: 0 0 0 2px rgba(0,123,255,0.1); }
    </style>

    <div style="max-width: 900px; margin: 20px auto; font-family: sans-serif;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h2 id="titulo-pagina" style="color: #333; font-weight: 700;">GestiÃ³n de Usuarios</h2>
            <div style="display: flex; gap: 10px;">
                {# BUSCADOR COQUETO #}
                <input type="text" id="input-buscar" placeholder="ðŸ” Buscar por nombre..."
                       style="padding: 10px 15px; border: 1px solid #ddd; border-radius: 8px; outline: none; width: 250px; transition: 0.3s;" class="input-busqueda">
                <button id="btn-abrir-form" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">+ Nueva Persona</button>
            </div>
        </div>

        {# VISTA 1: TABLA #}
        <div id="vista-tabla" style="animation: fadeIn 0.4s;">
            <div class="card-deidad">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                    <tr style="border-bottom: 2px solid #f8f9fa; text-align: left; color: #999; font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">
                        <th style="padding: 15px;">Nombre Completo</th>
                        <th style="padding: 15px;">Correo ElectrÃ³nico</th>
                    </tr>
                    </thead>
                    <tbody id="cuerpo-tabla" style="color: #555; font-size: 14px;"></tbody>
                </table>
                <div id="paginacion" style="display: flex; gap: 8px; justify-content: center; margin-top: 25px;"></div>
            </div>
        </div>

        {# VISTA 2: FORMULARIO (NUEVO / EDITAR) #}
        <div id="vista-formulario" style="display: none; animation: fadeIn 0.4s;">
            <div class="card-deidad">
                <h3 id="form-titulo" style="margin-bottom: 25px; border-left: 4px solid #007bff; padding-left: 15px;">Registrar Persona</h3>
                <form id="form-registro" novalidate>
                    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold; font-size: 13px;">Nombre:</label>
                            <input type="text" id="nombre" name="nombre" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; outline: none;">
                        </div>
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold; font-size: 13px;">Email:</label>
                            <input type="email" id="email" name="email" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; outline: none;">
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 30px;">
                        <button type="submit" id="btn-guardar" disabled style="background: #ccc; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-weight: bold; cursor: not-allowed;">Guardar</button>
                        <button type="button" onclick="regresarALista()" style="background: #f8f9fa; border: 1px solid #ddd; padding: 12px 30px; border-radius: 8px; cursor: pointer;">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        {# VISTA 3: DETALLE DEL USUARIO #}
        <div id="vista-detalle" style="display: none; animation: fadeIn 0.4s;">
            <div class="card-deidad" style="text-align: center; padding: 40px;">
                <div style="width: 60px; height: 60px; background: #e9ecef; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #adb5bd;">ðŸ‘¤</div>
                <h3 id="det-nombre" style="font-size: 24px; margin: 0;"></h3>
                <p id="det-email" style="color: #007bff; margin: 10px 0; font-size: 16px;"></p>
                <div style="display: flex; justify-content: center; gap: 15px; margin-top: 30px; border-top: 1px solid #eee; padding-top: 25px;">
                    <button id="btn-edit-link" style="background: #333; color: white; border: none; padding: 10px 25px; border-radius: 8px; cursor: pointer; font-weight: bold;">Editar</button>
                    <button id="btn-delete-link" style="background: white; color: #dc3545; border: 1px solid #dc3545; padding: 10px 25px; border-radius: 8px; cursor: pointer; font-weight: bold;">Eliminar</button>
                    <button onclick="regresarALista()" style="background: #f8f9fa; border: 1px solid #ddd; padding: 10px 25px; border-radius: 8px; cursor: pointer;">Volver</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('form-registro');
        const btnGuardar = document.getElementById('btn-guardar');
        const inputs = form.querySelectorAll('input[required]');
        const inputBuscar = document.getElementById('input-buscar');
        let editandoId = null;
        let busquedaActual = '';

        // --- BUSCADOR (FILTRO EN TIEMPO REAL) ---
        inputBuscar.addEventListener('input', (e) => {
            busquedaActual = e.target.value;
            cargarPersonas(1); // Reset a pÃ¡gina 1 al buscar
        });

        // --- VALIDACIÃ“N DE BOTÃ“N ---
        form.oninput = () => {
            let esValido = true;
            const regexNombre = /^[a-zA-ZÃÃ‰ÃÃ“ÃšÃ¡Ã©Ã­Ã³ÃºÃ±Ã‘\s]+$/;
            inputs.forEach(i => {
                if (!i.value.trim()) esValido = false;
                if (i.id === 'nombre' && !regexNombre.test(i.value)) esValido = false;
            });
            btnGuardar.disabled = !esValido;
            btnGuardar.style.background = esValido ? '#28a745' : '#ccc';
            btnGuardar.style.cursor = esValido ? 'pointer' : 'not-allowed';
        };

        // --- NAVEGACIÃ“N ---
        function regresarALista() {
            document.getElementById('vista-tabla').style.display = 'block';
            document.getElementById('vista-formulario').style.display = 'none';
            document.getElementById('vista-detalle').style.display = 'none';
            document.getElementById('btn-abrir-form').style.display = 'block';
            inputBuscar.style.display = 'block';
            document.getElementById('titulo-pagina').innerText = "GestiÃ³n de Usuarios";
            editandoId = null;
            form.reset();
            cargarPersonas();
        }

        document.getElementById('btn-abrir-form').onclick = () => {
            document.getElementById('vista-tabla').style.display = 'none';
            document.getElementById('vista-formulario').style.display = 'block';
            document.getElementById('btn-abrir-form').style.display = 'none';
            inputBuscar.style.display = 'none';
            document.getElementById('form-titulo').innerText = "Nuevo Registro";
        };

        // --- CARGAR DATOS CON FILTRO ---
        async function cargarPersonas(pagina = 1) {
            // Pasamos el parÃ¡metro de bÃºsqueda a la API (opcional, aquÃ­ filtramos el array que llega)
            const res = await fetch(`/api/personas?page=${pagina}`);
            const data = await res.json();

            // FILTRADO CLIENT-SIDE (Para no complicar el Controller mÃ¡s)
            let itemsFiltrados = data.items;
            if (busquedaActual) {
                itemsFiltrados = itemsFiltrados.filter(p =>
                    p.nombre.toLowerCase().includes(busquedaActual.toLowerCase())
                );
            }

            const cuerpo = document.getElementById('cuerpo-tabla');
            cuerpo.innerHTML = '';

            if (itemsFiltrados.length === 0) {
                cuerpo.innerHTML = '<tr><td colspan="2" style="padding: 20px; text-align: center; color: #999;">No se encontraron deidades con ese nombre.</td></tr>';
            }

            itemsFiltrados.forEach(p => {
                const fila = document.createElement('tr');
                fila.className = 'fila-usuario';
                fila.innerHTML = `<td style="padding: 15px; font-weight: 500;">${p.nombre}</td><td style="padding: 15px; color: #777;">${p.email}</td>`;
                fila.onclick = () => verDetalle(p.id);
                cuerpo.appendChild(fila);
            });
            actualizarPaginador(data.pages, data.current_page);
        }

        async function verDetalle(id) {
            const res = await fetch(`/api/personas/${id}`);
            const p = await res.json();
            document.getElementById('det-nombre').innerText = p.nombre;
            document.getElementById('det-email').innerText = p.email;
            document.getElementById('btn-delete-link').onclick = () => eliminar(id);
            document.getElementById('btn-edit-link').onclick = () => {
                editandoId = p.id;
                document.getElementById('nombre').value = p.nombre;
                document.getElementById('email').value = p.email;
                document.getElementById('vista-detalle').style.display = 'none';
                document.getElementById('vista-formulario').style.display = 'block';
                document.getElementById('form-titulo').innerText = "Editar Perfil";
            };
            document.getElementById('vista-tabla').style.display = 'none';
            document.getElementById('vista-detalle').style.display = 'block';
            document.getElementById('btn-abrir-form').style.display = 'none';
            inputBuscar.style.display = 'none';
        }

        form.onsubmit = async (e) => {
            e.preventDefault();
            const url = editandoId ? `/api/personas/${editandoId}` : '/api/personas/nuevo';
            const response = await fetch(url, {
                method: editandoId ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(Object.fromEntries(new FormData(form).entries()))
            });
            if (response.ok) {
                alert(editandoId ? "Â¡Actualizado!" : "Â¡Guardado!");
                regresarALista();
            }
        };

        async function eliminar(id) {
            if (confirm("Â¿Borrar definitivamente?")) {
                await fetch(`/api/personas/${id}`, { method: 'DELETE' });
                regresarALista();
            }
        }

        function actualizarPaginador(total, actual) {
            const cont = document.getElementById('paginacion');
            cont.innerHTML = '';

            const btnIni = document.createElement('button');
            btnIni.innerText = '<<';
            btnIni.className = 'btn-pag';
            btnIni.disabled = (actual === 1);
            btnIni.onclick = () => cargarPersonas(1);
            cont.appendChild(btnIni);

            for (let i = 1; i <= total; i++) {
                if (i === 1 || i === total || (i >= actual - 1 && i <= actual + 1)) {
                    const btn = document.createElement('button');
                    btn.innerText = i;
                    btn.className = `btn-pag ${i === actual ? 'active' : ''}`;
                    btn.onclick = () => cargarPersonas(i);
                    cont.appendChild(btn);
                } else if (i === actual - 2 || i === actual + 2) {
                    const dots = document.createElement('span');
                    dots.innerText = '...';
                    dots.style.padding = '8px';
                    cont.appendChild(dots);
                }
            }

            const btnFin = document.createElement('button');
            btnFin.innerText = '>>';
            btnFin.className = 'btn-pag';
            btnFin.disabled = (actual === total);
            btnFin.onclick = () => cargarPersonas(total);
            cont.appendChild(btnFin);
        }

        cargarPersonas();
    </script>
{% endblock %}
